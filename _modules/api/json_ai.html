

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>api.json_ai &mdash; lightwood 25.3.3.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
      <script src="../../_static/jquery.js"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
      <script src="../../_static/doctools.js"></script>
      <script src="../../_static/sphinx_highlight.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/mindsdblogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Tutorials</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">API</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Data</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../encoder.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Encoders</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mixer.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Mixers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ensemble.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Ensemble</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Analysis</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helpers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Helpers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lightwood_philosophy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Lightwood</span> <span class="pre">Philosophy</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lightwood</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">api.json_ai</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for api.json_ai</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO: add_implicit_values unit test ensures NO changes for a fully specified file.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">type_infer.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="n">dtype</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">type_infer.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeInformation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataprep_ml</span><span class="w"> </span><span class="kn">import</span> <span class="n">StatisticalAnalysis</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lightwood.helpers.templating</span><span class="w"> </span><span class="kn">import</span> <span class="n">_consolidate_analysis_blocks</span><span class="p">,</span> <span class="n">_add_cls_kwarg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightwood.helpers.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">IMPORTS</span><span class="p">,</span> <span class="n">IMPORT_EXTERNAL_DIRS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightwood.api.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">JsonAI</span><span class="p">,</span>
    <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightwood.ensemble</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightwood.encoder</span>


<div class="viewcode-block" id="lookup_encoder"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.lookup_encoder">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">lookup_encoder</span><span class="p">(</span>
    <span class="n">col_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_target</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">problem_defintion</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
    <span class="n">is_target_predicting_encoder</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">statistical_analysis</span><span class="p">:</span> <span class="n">StatisticalAnalysis</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign a default encoder for a given column based on its data type, and whether it is a target. Encoders intake raw (but cleaned) data and return an feature representation. This function assigns, per data type, what the featurizer should be. This function runs on each column within the dataset available for model building to assign how it should be featurized.</span>

<span class="sd">    Users may override to create a custom encoder to enable their own featurization process. However, in order to generate template JSON-AI, this code runs automatically. Users may edit the generated syntax and use custom approaches while model building.</span>

<span class="sd">    For each encoder, &quot;args&quot; may be passed. These args depend an encoder requires during its preparation call.</span>

<span class="sd">    :param col_dtype: A data-type of a column specified</span>
<span class="sd">    :param col_name: The name of the column</span>
<span class="sd">    :param is_target: Whether the column is the target for prediction. If true, only certain possible feature representations are allowed, particularly for complex data types.</span>
<span class="sd">    :param problem_definition: The ``ProblemDefinition`` criteria; this populates specifics on how models and encoders may be trained.</span>
<span class="sd">    :param is_target_predicting_encoder:</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="n">encoder_lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">:</span> <span class="s2">&quot;NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">:</span> <span class="s2">&quot;NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span> <span class="s2">&quot;BinaryEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;CategoricalAutoEncoder&quot;</span>
        <span class="k">if</span> <span class="n">statistical_analysis</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_analysis</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">16</span>
        <span class="k">else</span> <span class="s2">&quot;OneHotEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="s2">&quot;MultiHotEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="s2">&quot;DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="s2">&quot;DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">image</span><span class="p">:</span> <span class="s2">&quot;Img2VecEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;PretrainedLangEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">short_text</span><span class="p">:</span> <span class="s2">&quot;CategoricalAutoEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span> <span class="s2">&quot;NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">audio</span><span class="p">:</span> <span class="s2">&quot;MFCCEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">num_array</span><span class="p">:</span> <span class="s2">&quot;NumArrayEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">cat_array</span><span class="p">:</span> <span class="s2">&quot;CatArrayEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span><span class="p">:</span> <span class="s2">&quot;TimeSeriesEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">cat_tsarray</span><span class="p">:</span> <span class="s2">&quot;TimeSeriesEncoder&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># If column is a target, only specific feature representations are allowed that enable supervised tasks</span>
    <span class="n">target_encoder_lookup_override</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;VocabularyEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;OneHotEncoder&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Assign a default encoder to each column.</span>
    <span class="n">encoder_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">encoder_lookup</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">],</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># If the column is a target, ensure that the feature representation can enable supervised tasks</span>
    <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_target&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">target_encoder_lookup_override</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_encoder_lookup_override</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">unbias_target</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;target_weights&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$statistical_analysis.target_weights&quot;</span>
            <span class="k">if</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">target_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;target_weights&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">target_weights</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">num_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span><span class="p">):</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                <span class="s2">&quot;positive_domain&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span>

            <span class="k">if</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">target_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;target_weights&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">target_weights</span>

    <span class="c1"># Time-series representations require more advanced flags</span>
    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="n">gby</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">in</span> <span class="n">gby</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The `order_by` column cannot be used to `group_by` simultaneously!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="n">tss</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ArrayEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">target_type</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">horizon</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timesteps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">horizon</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span><span class="p">]:</span>
                    <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TsArrayNumericEncoder&quot;</span>
                <span class="k">elif</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">cat_tsarray</span><span class="p">]:</span>
                    <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TsCatArrayEncoder&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;__mdb_ts_previous&quot;</span> <span class="ow">in</span> <span class="n">col_name</span> <span class="ow">or</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">historical_columns</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TimeSeriesEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">target_type</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Set arguments for the encoder</span>
    <span class="k">if</span> <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PretrainedLangEncoder&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;output_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$dtype_dict[$target]&quot;</span>

    <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_trainable_encoder</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;stop_after&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.seconds_per_encoder&quot;</span>

    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;embed_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">return</span> <span class="n">encoder_dict</span></div>


<div class="viewcode-block" id="generate_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.generate_json_ai">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">generate_json_ai</span><span class="p">(</span>
    <span class="n">type_information</span><span class="p">:</span> <span class="n">TypeInformation</span><span class="p">,</span>
    <span class="n">statistical_analysis</span><span class="p">:</span> <span class="n">StatisticalAnalysis</span><span class="p">,</span>
    <span class="n">problem_definition</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given ``type_infer.TypeInformation``, ``dataprep_ml.StatisticalAnalysis``, and the ``ProblemDefinition``, generate a JSON config file with the necessary elements of the ML pipeline populated.</span>

<span class="sd">    :param TypeInformation: Specifies what data types each column within the dataset are. Generated by `mindsdb/type_infer`.</span>
<span class="sd">    :param statistical_analysis:</span>
<span class="sd">    :param problem_definition: Specifies details of the model training/building procedure, as defined by ``ProblemDefinition``</span>

<span class="sd">    :returns: JSON-AI object with fully populated details of the ML pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqaexec</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORTS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORT_EXTERNAL_DIRS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span>
    <span class="n">input_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dependency_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span>

    <span class="n">dtype_dict_override</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">dtype_dict</span>
    <span class="n">dtype_dict</span> <span class="o">=</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">and</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dtype_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dtype_dict_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dtype_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">dtype_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span>
                 <span class="ow">and</span> <span class="n">col_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">invalid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="n">col_name</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span>
                <span class="ow">or</span>
                <span class="p">(</span><span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="o">!=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="n">input_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

    <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_ts</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
    <span class="n">imputers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Single text column classification</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">input_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">submodels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">submodels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Unit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;target_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;$encoders[self.target]&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># add neural model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
            <span class="n">submodels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Neural&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">submodels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;NeuralTs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># add other models</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">or</span> <span class="n">tss</span><span class="o">.</span><span class="n">horizon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">num_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">cat_array</span><span class="p">):</span>
            <span class="n">submodels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;XGBoostMixer&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Regression&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;RandomForest&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># special forecasting dispatch</span>
        <span class="k">elif</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
            <span class="n">submodels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">{</span>
                    <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;XGBoostArrayMixer&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="p">},</span>
            <span class="p">])</span>

    <span class="n">model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;BestOf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;submodels&quot;</span><span class="p">:</span> <span class="n">submodels</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">num_ts_dtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">and</span> <span class="n">tss</span><span class="o">.</span><span class="n">horizon</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">in</span> <span class="n">num_ts_dtypes</span><span class="p">:</span>
            <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">anomaly_detection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">cat_tsarray</span>
    <span class="k">elif</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">and</span> <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">in</span> <span class="n">num_ts_dtypes</span><span class="p">:</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">anomaly_detection</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">encoders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">lookup_encoder</span><span class="p">(</span>
            <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="n">problem_definition</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="n">statistical_analysis</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">:</span>
        <span class="n">encoders</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_encoder</span><span class="p">(</span>
            <span class="n">dtype_dict</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
            <span class="n">col</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="n">problem_definition</span><span class="p">,</span>
            <span class="n">is_target_predicting_encoder</span><span class="p">,</span>
            <span class="n">statistical_analysis</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Decide on the accuracy functions to use</span>
    <span class="n">output_dtype</span> <span class="o">=</span> <span class="n">dtype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r2_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">]:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;balanced_accuracy_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;complementary_smape_array_accuracy&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">num_array</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evaluate_num_array_accuracy&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">cat_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">cat_tsarray</span><span class="p">):</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evaluate_cat_array_accuracy&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please specify a custom accuracy function for output type </span><span class="si">{</span><span class="n">output_dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_ts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">]:</span>
            <span class="c1"># forces this acc fn for t+1 time series forecasters</span>
            <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;complementary_smape_array_accuracy&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">num_tsarray</span><span class="p">):</span>
            <span class="n">imputers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;NumericalImputer&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;zero&#39;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}}</span>
                            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">cat_tsarray</span><span class="p">]:</span>
            <span class="n">imputers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;CategoricalImputer&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;mode&#39;&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}}</span>
                            <span class="p">)</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 5 days</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>

    <span class="c1"># Encoders are assigned 1/3 of the time unless a user overrides this (equal time per encoder)</span>
    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nr_trainable_encoders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">encoders</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_trainable_encoder</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">nr_trainable_encoders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="o">=</span> <span class="mf">0.33</span> <span class="o">*</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">/</span> <span class="n">nr_trainable_encoders</span>

    <span class="c1"># Mixers are assigned 1/3 of the time aim (or 2/3 if there are no trainable encoders )\</span>
    <span class="c1"># unless a user overrides this (equal time per mixer)</span>
    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_mixer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_mixer</span> <span class="o">=</span> <span class="mf">0.66</span> <span class="o">*</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;submodels&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_mixer</span> <span class="o">=</span> <span class="mf">0.33</span> <span class="o">*</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;submodels&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">JsonAI</span><span class="p">(</span>
        <span class="n">cleaner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">explainer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">encoders</span><span class="o">=</span><span class="n">encoders</span><span class="p">,</span>
        <span class="n">imputers</span><span class="o">=</span><span class="n">imputers</span><span class="p">,</span>
        <span class="n">dtype_dict</span><span class="o">=</span><span class="n">dtype_dict</span><span class="p">,</span>
        <span class="n">dependency_dict</span><span class="o">=</span><span class="n">dependency_dict</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">problem_definition</span><span class="o">=</span><span class="n">problem_definition</span><span class="p">,</span>
        <span class="n">identifiers</span><span class="o">=</span><span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span>
        <span class="n">timeseries_transformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeseries_analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accuracy_functions</span><span class="o">=</span><span class="n">accuracy_functions</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for `_populate_implicit_field`.</span>
<span class="sd">    Takes a user-defined field along with its implicit value, and merges them together.</span>

<span class="sd">    :param field: JsonAI field with user-defined parameters.</span>
<span class="sd">    :param implicit_value: implicit values for the field.</span>
<span class="sd">    :return: original field with implicit values merged into it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORTS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORT_EXTERNAL_DIRS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                    <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">field</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_populate_implicit_field</span><span class="p">(</span>
    <span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">is_timeseries</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate the implicit field of the JsonAI, either by filling it in entirely if missing, or by introspecting the class or function and assigning default values to the args in it&#39;s signature that are in the implicit default but haven&#39;t been populated by the user</span>

<span class="sd">    :params: json_ai: ``JsonAI`` object that describes the ML pipeline that may not have every detail fully specified.</span>
<span class="sd">    :params: field_name: Name of the field the implicit field in ``JsonAI``</span>
<span class="sd">    :params: implicit_value: The dictionary containing implicit values for the module and arg in the field</span>
<span class="sd">    :params: is_timeseries: Whether or not this is a timeseries problem</span>

<span class="sd">    :returns: nothing, this method mutates the respective field of the ``JsonAI`` object it receives</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="c1"># These imports might be slow, in which case the only &lt;easy&gt; solution is to line this code</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This if is to only populated timeseries-specific implicit fields for implicit problems</span>
        <span class="k">if</span> <span class="n">is_timeseries</span> <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timeseries_transformer&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">implicit_value</span>

    <span class="c1"># If the user specified one or more subfields in a field that&#39;s a list</span>
    <span class="c1"># Populate them with implicit arguments form the implicit values from that subfield</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">implicit_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)):</span>
            <span class="n">sub_field_implicit</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">implicit_value</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_field_implicit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sub_field_implicit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">sub_field_implicit</span> <span class="ow">in</span> <span class="n">implicit_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sub_field_implicit</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]])</span>
                <span class="o">==</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_field_implicit</span><span class="p">)</span>
    <span class="c1"># If the user specified the field, add implicit arguments which we didn&#39;t specify</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">)</span>
    <span class="n">json_ai</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>


<div class="viewcode-block" id="add_implicit_values"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.add_implicit_values">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">add_implicit_values</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To enable brevity in writing, auto-generate the &quot;unspecified/missing&quot; details required in the ML pipeline.</span>

<span class="sd">    :params: json_ai: ``JsonAI`` object that describes the ML pipeline that may not have every detail fully specified.</span>

<span class="sd">    :returns: ``JSONAI`` object with all necessary parameters that were previously left unmentioned filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem_definition</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span>
    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="n">is_ts</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span>
    <span class="n">mixers</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;submodels&#39;</span><span class="p">]</span>

    <span class="c1"># Add implicit ensemble arguments</span>
    <span class="n">param_pairs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">),</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;encoded_test_data&quot;</span><span class="p">),</span>
        <span class="s1">&#39;mixers&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mixers&quot;</span><span class="p">,</span> <span class="s2">&quot;$mixers&quot;</span><span class="p">),</span>
        <span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;$pred_args&quot;</span><span class="p">),</span>
        <span class="s1">&#39;accuracy_functions&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;accuracy_functions&quot;</span><span class="p">,</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">),</span>
        <span class="s1">&#39;ts_analysis&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;self.ts_analysis&quot;</span> <span class="k">if</span> <span class="n">is_ts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;dtype_dict&#39;</span><span class="p">:</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">ensemble_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lightwood</span><span class="o">.</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
    <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="n">param_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_add_cls_kwarg</span><span class="p">(</span><span class="n">ensemble_cls</span><span class="p">,</span> <span class="n">filtered_params</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>

    <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_params</span>
    <span class="n">json_ai</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s1">&#39;submodels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span>  <span class="c1"># add mixers back in</span>

    <span class="c1"># Add implicit mixer arguments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mixers</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Unit&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># common</span>
        <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
        <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">)</span>
        <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;stop_after&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop_after&quot;</span><span class="p">,</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">)</span>

        <span class="c1"># specific</span>
        <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Neural&quot;</span><span class="p">,</span> <span class="s2">&quot;NeuralTs&quot;</span><span class="p">,</span> <span class="s2">&quot;TabTransformerMixer&quot;</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Neural&quot;</span><span class="p">,</span> <span class="s2">&quot;NeuralTs&quot;</span><span class="p">):</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;net&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;net&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;&quot;DefaultNet&quot;&#39;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">use_previous_target</span>
                    <span class="k">else</span> <span class="s1">&#39;&quot;ArNet&quot;&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NeuralTs&quot;</span><span class="p">:</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timeseries_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">,</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span>
                <span class="p">)</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TabTransformerMixer&quot;</span><span class="p">:</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;LightGBM&quot;</span><span class="p">,</span> <span class="s2">&quot;XGBoostMixer&quot;</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;use_optuna&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Regression&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RandomForest&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;LightGBMArray&quot;</span><span class="p">,</span> <span class="s2">&quot;XGBoostArrayMixer&quot;</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;tss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tss&quot;</span><span class="p">,</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit_on_dev&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;use_stl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_stl&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NHitsMixer&quot;</span><span class="p">,</span> <span class="s2">&quot;GluonTSMixer&quot;</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.timeseries_settings.horizon&quot;</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.timeseries_settings.window&quot;</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span>
            <span class="p">)</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">fit_on_all</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># takes too long otherwise</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SkTime&quot;</span><span class="p">,</span> <span class="s2">&quot;ProphetMixer&quot;</span><span class="p">,</span> <span class="s2">&quot;ETSMixer&quot;</span><span class="p">,</span> <span class="s2">&quot;ARIMAMixer&quot;</span><span class="p">):</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;horizon&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.timeseries_settings.horizon&quot;</span>

            <span class="c1"># enforce fit_on_all if this mixer is specified</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">fit_on_all</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># encoder checks</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">encoders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">dependency_dict</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">dependency_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># filter arguments for included encoders (custom encoders will skip the check)</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">enc_dict</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">encoders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">filtered_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lightwood</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">enc_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]):</span>
            <span class="n">encoder_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lightwood</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">enc_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">enc_dict</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_add_cls_kwarg</span><span class="p">(</span><span class="n">encoder_cls</span><span class="p">,</span> <span class="n">filtered_kwargs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_kwargs</span>

    <span class="c1"># Add &quot;hidden&quot; fields</span>
    <span class="n">hidden_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cleaner&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;cleaner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;pct_invalid&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.pct_invalid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;identifiers&quot;</span><span class="p">:</span> <span class="s2">&quot;$identifiers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;imputers&quot;</span><span class="p">:</span> <span class="s2">&quot;$imputers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.to_dict()&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_detection&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_detection&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;splitter&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;splitter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;tss&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.to_dict()&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seed_nr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pct_train&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s2">&quot;pct_dev&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">&quot;pct_test&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;model_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;stats_info&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pdef&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accuracy_functions&quot;</span><span class="p">:</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictor&quot;</span><span class="p">:</span> <span class="s2">&quot;$ensemble&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_test_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;train_data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_train_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;analysis_blocks&quot;</span><span class="p">:</span> <span class="s2">&quot;$analysis_blocks&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$ts_analysis&quot;</span> <span class="k">if</span> <span class="n">is_ts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;explainer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;explain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;problem_definition&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stat_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;encoded_data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span>
                <span class="s2">&quot;runtime_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$runtime_analyzer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$ts_analysis&quot;</span> <span class="k">if</span> <span class="n">is_ts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;target_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict[self.target]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;explainer_blocks&quot;</span><span class="p">:</span> <span class="s2">&quot;$analysis_blocks&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pred_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;analysis_blocks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;ICP&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fixed_significance&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;confidence_normalizer&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;AccStats&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ICP&quot;</span><span class="p">]},</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;ConfStats&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ICP&quot;</span><span class="p">]},</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;PermutationFeatureImportance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AccStats&quot;</span><span class="p">]},</span>
            <span class="p">},</span>
        <span class="p">]</span> <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">use_default_analysis</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="s2">&quot;timeseries_transformer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;transform_timeseries&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pred_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">implicit_value</span> <span class="ow">in</span> <span class="n">hidden_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_populate_implicit_field</span><span class="p">(</span><span class="n">json_ai</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">,</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">)</span>

    <span class="c1"># further consolidation</span>
    <span class="n">to_inspect</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;analysis_blocks&#39;</span><span class="p">]</span>
    <span class="n">consolidation_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;analysis_blocks&#39;</span><span class="p">:</span> <span class="n">_consolidate_analysis_blocks</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_inspect</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">consolidation_methods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">json_ai</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="p">(</span><span class="n">json_ai</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">json_ai</span></div>


<div class="viewcode-block" id="validate_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.validate_json_ai">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">validate_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the validity of a ``JsonAI`` object</span>

<span class="sd">    :param json_ai: A ``JsonAI`` object</span>

<span class="sd">    :returns: Whether the JsonAI is valid, i.e. doesn&#39;t contain prohibited values, unknown values and can be turned into code.</span>
<span class="sd">    &quot;&quot;&quot;</span> <span class="c1"># noqa</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lightwood.api.high_level</span><span class="w"> </span><span class="kn">import</span> <span class="n">predictor_from_code</span><span class="p">,</span> <span class="n">code_from_json_ai</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">predictor_from_code</span><span class="p">(</span><span class="n">code_from_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2025, MindsDB.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>