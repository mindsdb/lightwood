

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>api.json_ai &mdash; lightwood 1.5.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/mindsdblogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../lightwood_philosophy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Lightwood</span> <span class="pre">Philosophy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Tutorials</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">API</span> <span class="pre">Module</span></code></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lightwood</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>api.json_ai</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for api.json_ai</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO: _add_implicit_values unit test ensures NO changes for a fully specified file.</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">lightwood.helpers.templating</span> <span class="kn">import</span> <span class="n">call</span><span class="p">,</span> <span class="n">inline_dict</span><span class="p">,</span> <span class="n">align</span>
<span class="kn">from</span> <span class="nn">lightwood.api</span> <span class="kn">import</span> <span class="n">dtype</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">lightwood.api.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">JsonAI</span><span class="p">,</span>
    <span class="n">TypeInformation</span><span class="p">,</span>
    <span class="n">StatisticalAnalysis</span><span class="p">,</span>
    <span class="n">Feature</span><span class="p">,</span>
    <span class="n">Output</span><span class="p">,</span>
    <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">lightwood.helpers.log</span> <span class="kn">import</span> <span class="n">log</span>


<span class="c1"># For custom modules, we create a module loader with necessary imports below</span>
<span class="n">IMPORT_EXTERNAL_DIRS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">for import_dir in [os.path.expanduser(&#39;~/lightwood_modules&#39;), &#39;/etc/lightwood_modules&#39;]:</span>
<span class="s2">    if os.path.exists(import_dir) and os.access(import_dir, os.R_OK):</span>
<span class="s2">        for file_name in list(os.walk(import_dir))[0][2]:</span>
<span class="s2">            if file_name[-3:] != &#39;.py&#39;:</span>
<span class="s2">                continue</span>
<span class="s2">            mod_name = file_name[:-3]</span>
<span class="s2">            loader = importlib.machinery.SourceFileLoader(mod_name,</span>
<span class="s2">                                                          os.path.join(import_dir, file_name))</span>
<span class="s2">            module = ModuleType(loader.name)</span>
<span class="s2">            loader.exec_module(module)</span>
<span class="s2">            sys.modules[mod_name] = module</span>
<span class="s2">            exec(f&#39;import </span><span class="si">{mod_name}</span><span class="s2">&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">IMPORTS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import lightwood</span>
<span class="s2">from lightwood.analysis import *</span>
<span class="s2">from lightwood.api import *</span>
<span class="s2">from lightwood.data import *</span>
<span class="s2">from lightwood.encoder import *</span>
<span class="s2">from lightwood.ensemble import *</span>
<span class="s2">from lightwood.helpers.device import *</span>
<span class="s2">from lightwood.helpers.general import *</span>
<span class="s2">from lightwood.helpers.log import *</span>
<span class="s2">from lightwood.helpers.numeric import *</span>
<span class="s2">from lightwood.helpers.parallelism import *</span>
<span class="s2">from lightwood.helpers.seed import *</span>
<span class="s2">from lightwood.helpers.text import *</span>
<span class="s2">from lightwood.helpers.torch import *</span>
<span class="s2">from lightwood.mixer import *</span>
<span class="s2">import pandas as pd</span>
<span class="s2">from typing import Dict, List</span>
<span class="s2">import os</span>
<span class="s2">from types import ModuleType</span>
<span class="s2">import importlib.machinery</span>
<span class="s2">import sys</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="lookup_encoder"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.lookup_encoder">[docs]</a><span class="k">def</span> <span class="nf">lookup_encoder</span><span class="p">(</span>
    <span class="n">col_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_target</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">problem_defintion</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
    <span class="n">is_target_predicting_encoder</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">statistical_analysis</span><span class="p">:</span> <span class="n">StatisticalAnalysis</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign a default encoder for a given column based on its data type, and whether it is a target. Encoders intake raw (but cleaned) data and return an feature representation. This function assigns, per data type, what the featurizer should be. This function runs on each column within the dataset available for model building to assign how it should be featurized.</span>

<span class="sd">    Users may override to create a custom encoder to enable their own featurization process. However, in order to generate template JSON-AI, this code runs automatically. Users may edit the generated syntax and use custom approaches while model building.</span>

<span class="sd">    For each encoder, &quot;args&quot; may be passed. These args depend an encoder requires during its preparation call.</span>

<span class="sd">    :param col_dtype: A data-type of a column specified</span>
<span class="sd">    :param col_name: The name of the column</span>
<span class="sd">    :param is_target: Whether the column is the target for prediction. If true, only certain possible feature representations are allowed, particularly for complex data types.</span>
<span class="sd">    :param problem_definition: The ``ProblemDefinition`` criteria; this populates specifics on how models and encoders may be trained.</span>
<span class="sd">    :param is_target_predicting_encoder:</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="n">encoder_lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">:</span> <span class="s2">&quot;Integer.NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">:</span> <span class="s2">&quot;Float.NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span> <span class="s2">&quot;Binary.BinaryEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;Categorical.CategoricalAutoEncoder&quot;</span>
        <span class="k">if</span> <span class="n">statistical_analysis</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_analysis</span><span class="o">.</span><span class="n">histograms</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span>
        <span class="k">else</span> <span class="s2">&quot;Categorical.OneHotEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="s2">&quot;Tags.MultiHotEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="s2">&quot;Date.DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="s2">&quot;Datetime.DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">image</span><span class="p">:</span> <span class="s2">&quot;Image.Img2VecEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;Rich_Text.PretrainedLangEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">short_text</span><span class="p">:</span> <span class="s2">&quot;Short_Text.CategoricalAutoEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="s2">&quot;Array.ArrayEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">tsarray</span><span class="p">:</span> <span class="s2">&quot;TimeSeries.TimeSeriesEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span> <span class="s2">&quot;Quantity.NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">audio</span><span class="p">:</span> <span class="s2">&quot;Audio.MFCCEncoder&quot;</span>
    <span class="p">}</span>

    <span class="c1"># If column is a target, only specific feature representations are allowed that enable supervised tasks</span>
    <span class="n">target_encoder_lookup_override</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;Rich_Text.VocabularyEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;Categorical.OneHotEncoder&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Assign a default encoder to each column.</span>
    <span class="n">encoder_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">encoder_lookup</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">],</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># If the column is a target, ensure that the feature representation can enable supervised tasks</span>
    <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_target&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">target_encoder_lookup_override</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_encoder_lookup_override</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">unbias_target</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;target_class_distribution&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$statistical_analysis.target_class_distribution&quot;</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tsarray</span><span class="p">):</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                <span class="s2">&quot;positive_domain&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span>

    <span class="c1"># Time-series representations require more advanced flags</span>
    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="n">gby</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">order_by</span> <span class="o">+</span> <span class="n">tss</span><span class="o">.</span><span class="n">historical_columns</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_dtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.TimeSeriesEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">col_dtype</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;self.target&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Integer.TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Float.TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gby</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timesteps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TimeSeries.TsArrayNumericEncoder&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;__mdb_ts_previous&quot;</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Array.ArrayEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">target_type</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tss</span><span class="o">.</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Set arguments for the encoder</span>
    <span class="k">if</span> <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Rich_Text.PretrainedLangEncoder&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;output_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$dtype_dict[$target]&quot;</span>

    <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">is_trainable_encoder</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;stop_after&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.seconds_per_encoder&quot;</span>

    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;embed_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
    <span class="k">return</span> <span class="n">encoder_dict</span></div>


<div class="viewcode-block" id="generate_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.generate_json_ai">[docs]</a><span class="k">def</span> <span class="nf">generate_json_ai</span><span class="p">(</span>
    <span class="n">type_information</span><span class="p">:</span> <span class="n">TypeInformation</span><span class="p">,</span>
    <span class="n">statistical_analysis</span><span class="p">:</span> <span class="n">StatisticalAnalysis</span><span class="p">,</span>
    <span class="n">problem_definition</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given ``TypeInformation``, ``StatisticalAnalysis``, and the ``ProblemDefinition``, generate a JSON config file with the necessary elements of the ML pipeline populated.</span>

<span class="sd">    :param TypeInformation: Specifies what data types each column within the dataset are</span>
<span class="sd">    :param statistical_analysis:</span>
<span class="sd">    :param problem_definition: Specifies details of the model training/building procedure, as defined by ``ProblemDefinition``</span>

<span class="sd">    :returns: JSON-AI object with fully populated details of the ML pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqaexec</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORTS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORT_EXTERNAL_DIRS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span>
    <span class="n">input_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span>
            <span class="ow">and</span> <span class="n">col_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">invalid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">col_name</span> <span class="o">!=</span> <span class="n">target</span>
        <span class="p">):</span>
            <span class="n">input_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_ts</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
    <span class="c1"># Single text column classification</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">input_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">mixers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Unit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;target_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;$encoders[self.target]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mixers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Neural&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">or</span> <span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mixers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;LightGBM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Regression&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mixers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;LightGBMArray&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;n_ts_predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.nr_predictions&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
                <span class="n">mixers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;SkTime&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_mixer&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;n_ts_predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.nr_predictions&quot;</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Output</span><span class="p">(</span>
            <span class="n">data_dtype</span><span class="o">=</span><span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
            <span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mixers</span><span class="o">=</span><span class="n">mixers</span><span class="p">,</span>
            <span class="n">ensemble</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;BestOf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;accuracy_functions&quot;</span><span class="p">:</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ts_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;self.ts_analysis&quot;</span> <span class="k">if</span> <span class="n">is_ts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">and</span> <span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tsarray</span>

    <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">lookup_encoder</span><span class="p">(</span>
        <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="n">problem_definition</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">statistical_analysis</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">:</span>
        <span class="n">col_dtype</span> <span class="o">=</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
        <span class="n">dependency</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">lookup_encoder</span><span class="p">(</span>
            <span class="n">col_dtype</span><span class="p">,</span>
            <span class="n">col_name</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="n">problem_definition</span><span class="p">,</span>
            <span class="n">is_target_predicting_encoder</span><span class="p">,</span>
            <span class="n">statistical_analysis</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span>
            <span class="ow">and</span> <span class="nb">eval</span><span class="p">(</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">is_timeseries_encoder</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
                    <span class="n">dependency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
                <span class="n">dependency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__mdb_ts_previous_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
                <span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span> <span class="n">dependency</span><span class="o">=</span><span class="n">dependency</span><span class="p">,</span> <span class="n">data_dtype</span><span class="o">=</span><span class="n">col_dtype</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span> <span class="n">data_dtype</span><span class="o">=</span><span class="n">col_dtype</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>

    <span class="c1"># Decide on the accuracy functions to use</span>
    <span class="n">output_dtype</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span>
    <span class="k">if</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r2_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">]:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;balanced_accuracy_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">output_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tsarray</span><span class="p">):</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evaluate_array_accuracy&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please specify a custom accuracy function for output type </span><span class="si">{</span><span class="n">output_dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># special dispatch for t+1 time series forecasters</span>
    <span class="k">if</span> <span class="n">is_ts</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
            <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evaluate_array_accuracy&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_mixer</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1000</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">statistical_analysis</span><span class="o">.</span><span class="n">nr_rows</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="mi">4</span>
                    <span class="k">if</span> <span class="n">x</span>
                    <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">short_text</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">tsarray</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">video</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">audio</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="k">else</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">200</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nr_trainable_encoders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">is_trainable_encoder</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">nr_mixers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mixers</span><span class="p">)</span>
        <span class="n">encoder_time_budget_pct</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mf">3.3</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nr_trainable_encoders</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">nr_trainable_encoders</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">encoder_time_budget_pct</span> <span class="o">/</span> <span class="n">nr_trainable_encoders</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_mixer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">encoder_time_budget_pct</span><span class="p">)</span> <span class="o">/</span> <span class="n">nr_mixers</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonAI</span><span class="p">(</span>
        <span class="n">cleaner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">explainer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">problem_definition</span><span class="o">=</span><span class="n">problem_definition</span><span class="p">,</span>
        <span class="n">identifiers</span><span class="o">=</span><span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span>
        <span class="n">timeseries_transformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeseries_analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accuracy_functions</span><span class="o">=</span><span class="n">accuracy_functions</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for `_populate_implicit_field`.</span>
<span class="sd">    Takes a user-defined field along with its implicit value, and merges them together.</span>

<span class="sd">    :param field: JsonAI field with user-defined parameters.</span>
<span class="sd">    :param implicit_value: implicit values for the field.</span>
<span class="sd">    :return: original field with implicit values merged into it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORTS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">IMPORT_EXTERNAL_DIRS</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                    <span class="n">field</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">implicit_value</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">field</span>


<span class="k">def</span> <span class="nf">_populate_implicit_field</span><span class="p">(</span>
    <span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">is_timeseries</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate the implicit field of the JsonAI, either by filling it in entirely if missing, or by introspecting the class or function and assigning default values to the args in it&#39;s signature that are in the implicit default but haven&#39;t been populated by the user</span>

<span class="sd">    :params: json_ai: ``JsonAI`` object that describes the ML pipeline that may not have every detail fully specified.</span>
<span class="sd">    :params: field_name: Name of the field the implicit field in ``JsonAI``</span>
<span class="sd">    :params: implicit_value: The dictionary containing implicit values for the module and arg in the field</span>
<span class="sd">    :params: is_timeseries: Whether or not this is a timeseries problem</span>

<span class="sd">    :returns: nothing, this method mutates the respective field of the ``JsonAI`` object it receives</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="c1"># These imports might be slow, in which case the only &lt;easy&gt; solution is to line this code</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This if is to only populated timeseries-specific implicit fields for implicit problems</span>
        <span class="k">if</span> <span class="n">is_timeseries</span> <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timeseries_transformer&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">implicit_value</span>

    <span class="c1"># If the user specified one or more subfields in a field that&#39;s a list</span>
    <span class="c1"># Populate them with implicit arguments form the implicit values from that subfield</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">implicit_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)):</span>
            <span class="n">sub_field_implicit</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">implicit_value</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_field_implicit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sub_field_implicit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">sub_field_implicit</span> <span class="ow">in</span> <span class="n">implicit_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sub_field_implicit</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]])</span>
                <span class="o">==</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_field_implicit</span><span class="p">)</span>
    <span class="c1"># If the user specified the field, add implicit arguments which we didn&#39;t specify</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">_merge_implicit_values</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">)</span>
    <span class="n">json_ai</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_implicit_values</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To enable brevity in writing, auto-generate the &quot;unspecified/missing&quot; details required in the ML pipeline.</span>

<span class="sd">    :params: json_ai: ``JsonAI`` object that describes the ML pipeline that may not have every detail fully specified.</span>

<span class="sd">    :returns: ``JSONAI`` object with all necessary parameters that were previously left unmentioned filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem_definition</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span>
    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span>

    <span class="c1"># Add implicit arguments</span>
    <span class="c1"># @TODO: Consider removing once we have a proper editor in studio</span>
    <span class="n">mixers</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">mixers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mixers</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Unit&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Neural&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timeseries_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">,</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;net&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;net&quot;</span><span class="p">,</span>
                <span class="s1">&#39;&quot;DefaultNet&quot;&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tss</span><span class="o">.</span><span class="n">use_previous_target</span>
                <span class="k">else</span> <span class="s1">&#39;&quot;ArNet&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LightGBM&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Regression&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LightGBMArray&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SkTime&quot;</span><span class="p">:</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mixers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span>
            <span class="p">)</span>

    <span class="n">ensemble</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">ensemble</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;encoded_test_data&quot;</span><span class="p">)</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;mixers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mixers&quot;</span><span class="p">,</span> <span class="s2">&quot;$mixers&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dependency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dependency</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="c1"># Add &quot;hidden&quot; fields</span>
    <span class="n">hidden_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cleaner&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;cleaner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;pct_invalid&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.pct_invalid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;identifiers&quot;</span><span class="p">:</span> <span class="s2">&quot;$identifiers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_detection&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_detection&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;splitter&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;splitter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;tss&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pct_train&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s2">&quot;pct_dev&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">&quot;pct_test&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;model_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;stats_info&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_cfg&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accuracy_functions&quot;</span><span class="p">:</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictor&quot;</span><span class="p">:</span> <span class="s2">&quot;$ensemble&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_test_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;train_data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_train_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;analysis_blocks&quot;</span><span class="p">:</span> <span class="s2">&quot;$analysis_blocks&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;explainer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;explain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;positive_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_detection&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_detection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;encoded_data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span>
                <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$runtime_analyzer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$ts_analysis&quot;</span> <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;target_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict[self.target]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;explainer_blocks&quot;</span><span class="p">:</span> <span class="s2">&quot;$analysis_blocks&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fixed_confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args.fixed_confidence&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_error_rate&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args.anomaly_error_rate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_cooldown&quot;</span><span class="p">:</span> <span class="s2">&quot;$pred_args.anomaly_cooldown&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;analysis_blocks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;ICP&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fixed_significance&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;confidence_normalizer&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;positive_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;AccStats&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ICP&quot;</span><span class="p">]},</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">&quot;timeseries_transformer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;transform_timeseries&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">hidden_fields</span><span class="p">[</span><span class="s2">&quot;analysis_blocks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;GlobalFeatureImportance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;disable_column_importance&quot;</span><span class="p">:</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>

    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">implicit_value</span> <span class="ow">in</span> <span class="n">hidden_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_populate_implicit_field</span><span class="p">(</span><span class="n">json_ai</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">implicit_value</span><span class="p">,</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_ai</span>


<div class="viewcode-block" id="code_from_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.code_from_json_ai">[docs]</a><span class="k">def</span> <span class="nf">code_from_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a custom ``PredictorInterface`` given the specifications from ``JsonAI`` object.</span>

<span class="sd">    :param json_ai: ``JsonAI`` object with fully specified parameters</span>

<span class="sd">    :returns: Automated syntax of the ``PredictorInterface`` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ----------------- #</span>
    <span class="c1"># Fill in any missing values</span>
    <span class="n">json_ai</span> <span class="o">=</span> <span class="n">_add_implicit_values</span><span class="p">(</span><span class="n">json_ai</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Instantiate encoders</span>
    <span class="n">encoder_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="n">call</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Instantiate Depedencies</span>
    <span class="n">dependency_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>
    <span class="p">}</span>

    <span class="c1"># Populate features and their data-types</span>
    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">encoder</span><span class="p">)</span>
        <span class="n">dependency_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">dependency</span>
        <span class="n">dtype_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">data_dtype</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>

    <span class="c1"># Populate time-series specific details</span>
    <span class="n">tss</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span> <span class="ow">and</span> <span class="n">tss</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__mdb_ts_previous_</span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">target_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span>
            <span class="n">lookup_encoder</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span><span class="p">,</span>
                <span class="n">col_name</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dependency_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dtype_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>

    <span class="c1"># ----------------- #</span>

    <span class="n">input_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">]</span>
    <span class="n">input_cols</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">])</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Time-series specific code blocks</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">ts_transform_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ts_analyze_code</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ts_encoder_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_transformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts_transform_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&#39;Transforming timeseries data&#39;)</span>
<span class="s2">data = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_transformer</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">ts_analyze_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.ts_analysis = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_analyzer</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="c1"># @TODO: set these kwargs/properties in the json ai construction (if possible)</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_analyzer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts_encoder_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if encoder.is_timeseries_encoder:</span>
<span class="s2">    kwargs[&#39;ts_analysis&#39;] = self.ts_analysis</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="n">ts_target_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if encoder.is_target:</span>
<span class="s2">    encoder.normalizers = self.ts_analysis[&#39;target_normalizers&#39;]</span>
<span class="s2">    encoder.group_combinations = self.ts_analysis[&#39;group_combinations&#39;]</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts_target_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Statistical Analysis Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">analyze_data_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&quot;Performing statistical analysis on data&quot;)</span>
<span class="s2">self.statistical_analysis = lightwood.data.statistical_analysis(data,</span>
<span class="s2">                                                                self.dtype_dict,</span>
<span class="s2">                                                                </span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">identifiers</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                                                                self.problem_definition)</span>

<span class="s2"># Instantiate post-training evaluation</span>
<span class="s2">self.analysis_blocks = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">analysis_blocks</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">analyze_data_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">analyze_data_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Pre-processing Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">clean_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&#39;Cleaning the data&#39;)</span>
<span class="s2">data = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">cleaner</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2"># Time-series blocks</span>
<span class="si">{</span><span class="n">ts_transform_code</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ts_analyze_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clean_body</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if self.mode != &#39;predict&#39;:</span>
<span class="si">{</span><span class="n">align</span><span class="p">(</span><span class="n">ts_analyze_code</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">clean_body</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">return data&#39;</span>

    <span class="n">clean_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">clean_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Train-Test Splitter Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">split_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&quot;Splitting the data into train/test&quot;)</span>
<span class="s2">train_test_data = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">return train_test_data</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">split_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">split_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Prepare features Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">prepare_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.mode = &#39;train&#39;</span>

<span class="s2">if self.statistical_analysis is None:</span>
<span class="s2">    raise Exception(&quot;Please run analyze_data first&quot;)</span>

<span class="s2"># Column to encoder mapping</span>
<span class="s2">self.encoders = </span><span class="si">{</span><span class="n">inline_dict</span><span class="p">(</span><span class="n">encoder_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2"># Prepare the training + dev data</span>
<span class="s2">concatenated_train_dev = pd.concat([data[&#39;train&#39;], data[&#39;dev&#39;]])</span>

<span class="s2">log.info(&#39;Preparing the encoders&#39;)</span>

<span class="s2">encoder_prepping_dict = </span><span class="se">{{}}</span><span class="s2"></span>

<span class="s2"># Prepare encoders that do not require learned strategies</span>
<span class="s2">for col_name, encoder in self.encoders.items():</span>
<span class="s2">    if not encoder.is_trainable_encoder:</span>
<span class="s2">        encoder_prepping_dict[col_name] = [encoder, concatenated_train_dev[col_name], &#39;prepare&#39;]</span>
<span class="s2">        log.info(f&#39;Encoder prepping dict length of: </span><span class="se">{{</span><span class="s2">len(encoder_prepping_dict)</span><span class="se">}}</span><span class="s2">&#39;)</span>

<span class="s2"># Setup parallelization</span>
<span class="s2">parallel_prepped_encoders = mut_method_call(encoder_prepping_dict)</span>
<span class="s2">for col_name, encoder in parallel_prepped_encoders.items():</span>
<span class="s2">    self.encoders[col_name] = encoder</span>

<span class="s2"># Prepare the target</span>
<span class="s2">if self.target not in parallel_prepped_encoders:</span>
<span class="s2">    if self.encoders[self.target].is_trainable_encoder:</span>
<span class="s2">        self.encoders[self.target].prepare(data[&#39;train&#39;][self.target], data[&#39;dev&#39;][self.target])</span>
<span class="s2">    else:</span>
<span class="s2">        self.encoders[self.target].prepare(pd.concat([data[&#39;train&#39;], data[&#39;dev&#39;]])[self.target])</span>

<span class="s2"># Prepare any non-target encoders that are learned</span>
<span class="s2">for col_name, encoder in self.encoders.items():</span>
<span class="s2">    if encoder.is_trainable_encoder:</span>
<span class="s2">        priming_data = pd.concat([data[&#39;train&#39;], data[&#39;dev&#39;]])</span>
<span class="s2">        kwargs = </span><span class="se">{{}}</span><span class="s2"></span>
<span class="s2">        if self.dependencies[col_name]:</span>
<span class="s2">            kwargs[&#39;dependency_data&#39;] = </span><span class="se">{{}}</span><span class="s2"></span>
<span class="s2">            for col in self.dependencies[col_name]:</span>
<span class="s2">                kwargs[&#39;dependency_data&#39;][col] = </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">                    &#39;original_type&#39;: self.dtype_dict[col],</span>
<span class="s2">                    &#39;data&#39;: priming_data[col]</span>
<span class="s2">                </span><span class="se">}}</span><span class="s2"></span>
<span class="s2">            </span><span class="si">{</span><span class="n">align</span><span class="p">(</span><span class="n">ts_encoder_code</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        # If an encoder representation requires the target, provide priming data</span>
<span class="s2">        if hasattr(encoder, &#39;uses_target&#39;):</span>
<span class="s2">            kwargs[&#39;encoded_target_values&#39;] = parallel_prepped_encoders[self.target].encode(priming_data[self.target])</span>

<span class="s2">        encoder.prepare(data[&#39;train&#39;][col_name], data[&#39;dev&#39;][col_name], **kwargs)</span>

<span class="s2">    </span><span class="si">{</span><span class="n">align</span><span class="p">(</span><span class="n">ts_target_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">prepare_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">prepare_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Featurize Data Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">feature_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&#39;Featurizing the data&#39;)</span>

<span class="s2">feature_data = </span><span class="se">{{</span><span class="s2"> key: EncodedDs(self.encoders, data, self.target) for key, data in split_data.items() if key != &quot;stratified_on&quot;</span><span class="se">}}</span><span class="s2"></span>

<span class="s2">return feature_data</span>

<span class="s2">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="n">feature_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">feature_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Fit Mixer Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">fit_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.mode = &#39;train&#39;</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Extract data</span>
<span class="s2"># --------------- #</span>
<span class="s2"># Extract the featurized data into train/dev/test</span>
<span class="s2">encoded_train_data = enc_data[&#39;train&#39;]</span>
<span class="s2">encoded_dev_data = enc_data[&#39;dev&#39;]</span>
<span class="s2">encoded_test_data = enc_data[&#39;test&#39;]</span>

<span class="s2">log.info(&#39;Training the mixers&#39;)</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Fit Models</span>
<span class="s2"># --------------- #</span>
<span class="s2"># Assign list of mixers</span>
<span class="s2">self.mixers = [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mixers</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span>

<span class="s2"># Train mixers</span>
<span class="s2">trained_mixers = []</span>
<span class="s2">for mixer in self.mixers:</span>
<span class="s2">    try:</span>
<span class="s2">        mixer.fit(encoded_train_data, encoded_dev_data)</span>
<span class="s2">        trained_mixers.append(mixer)</span>
<span class="s2">    except Exception as e:</span>
<span class="s2">        log.warning(f&#39;Exception: </span><span class="se">{{</span><span class="s2">e</span><span class="se">}}</span><span class="s2"> when training mixer: </span><span class="se">{{</span><span class="s2">mixer</span><span class="se">}}</span><span class="s2">&#39;)</span>
<span class="s2">        if </span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">strict_mode</span><span class="si">}</span><span class="s2"> and mixer.stable:</span>
<span class="s2">            raise e</span>

<span class="s2"># Update mixers to trained versions</span>
<span class="s2">self.mixers = trained_mixers</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Create Ensembles</span>
<span class="s2"># --------------- #</span>
<span class="s2">log.info(&#39;Ensembling the mixer&#39;)</span>
<span class="s2"># Create an ensemble of mixers to identify best performing model</span>
<span class="s2">self.pred_args = PredictionArguments()</span>
<span class="s2">self.ensemble = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ensemble</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">self.supports_proba = self.ensemble.supports_proba</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">fit_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">fit_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Analyze Ensemble Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">analyze_ensemble</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Extract data</span>
<span class="s2"># --------------- #</span>
<span class="s2"># Extract the featurized data into train/dev/test</span>
<span class="s2">encoded_train_data = enc_data[&#39;train&#39;]</span>
<span class="s2">encoded_dev_data = enc_data[&#39;dev&#39;]</span>
<span class="s2">encoded_test_data = enc_data[&#39;test&#39;]</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Analyze Ensembles</span>
<span class="s2"># --------------- #</span>
<span class="s2">log.info(&#39;Analyzing the ensemble of mixers&#39;)</span>
<span class="s2">self.model_analysis, self.runtime_analyzer = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">analyzer</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">analyze_ensemble</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">analyze_ensemble</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Adjust Ensemble Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">adjust_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.mode = &#39;train&#39;</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Extract data</span>
<span class="s2"># --------------- #</span>
<span class="s2"># Extract the featurized data</span>
<span class="s2">encoded_old_data = new_data[&#39;old&#39;]</span>
<span class="s2">encoded_new_data = new_data[&#39;new&#39;]</span>

<span class="s2"># --------------- #</span>
<span class="s2"># Adjust (Update) Mixers</span>
<span class="s2"># --------------- #</span>
<span class="s2">log.info(&#39;Updating the mixers&#39;)</span>

<span class="s2">for mixer in self.mixers:</span>
<span class="s2">    mixer.partial_fit(encoded_new_data, encoded_old_data)</span>
<span class="s2">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="n">adjust_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">adjust_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># ----------------- #</span>
    <span class="c1"># Learn Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">learn_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.mode = &#39;train&#39;</span>

<span class="s2"># Perform stats analysis</span>
<span class="s2">self.analyze_data(data)</span>

<span class="s2"># Pre-process the data</span>
<span class="s2">data = self.preprocess(data)</span>

<span class="s2"># Create train/test (dev) split</span>
<span class="s2">train_dev_test = self.split(data)</span>

<span class="s2"># Prepare encoders</span>
<span class="s2">self.prepare(train_dev_test)</span>

<span class="s2"># Create feature vectors from data</span>
<span class="s2">enc_train_test = self.featurize(train_dev_test)</span>

<span class="s2"># Prepare mixers</span>
<span class="s2">self.fit(enc_train_test)</span>

<span class="s2"># Analyze the ensemble</span>
<span class="s2">self.analyze_ensemble(enc_train_test)</span>

<span class="s2"># ------------------------ #</span>
<span class="s2"># Enable model partial fit AFTER it is trained and evaluated for performance with the appropriate train/dev/test splits.</span>
<span class="s2"># This assumes the predictor could continuously evolve, hence including reserved testing data may improve predictions.</span>
<span class="s2"># SET `json_ai.problem_definition.fit_on_all=False` TO TURN THIS BLOCK OFF.</span>

<span class="s2"># Update the mixers with partial fit</span>
<span class="s2">if self.problem_definition.fit_on_all:</span>

<span class="s2">    log.info(&quot;Adjustment on validation requested.&quot;)</span>
<span class="s2">    update_data = </span><span class="se">{{</span><span class="s2">&quot;new&quot;: enc_train_test[&quot;test&quot;], &quot;old&quot;: ConcatedEncodedDs([enc_train_test[&quot;train&quot;], enc_train_test[&quot;dev&quot;]])</span><span class="se">}}</span><span class="s2">  # noqa</span>

<span class="s2">    self.adjust(update_data)</span>

<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">learn_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">learn_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># ----------------- #</span>
    <span class="c1"># Predict Body</span>
    <span class="c1"># ----------------- #</span>

    <span class="n">predict_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Remove columns that user specifies to ignore</span>
<span class="s2">self.mode = &#39;predict&#39;</span>
<span class="s2">log.info(f&#39;Dropping features: </span><span class="se">{{</span><span class="s2">self.problem_definition.ignore_features</span><span class="se">}}</span><span class="s2">&#39;)</span>
<span class="s2">data = data.drop(columns=self.problem_definition.ignore_features, errors=&#39;ignore&#39;)</span>
<span class="s2">for col in self.input_cols:</span>
<span class="s2">    if col not in data.columns:</span>
<span class="s2">        data[col] = [None] * len(data)</span>

<span class="s2"># Pre-process the data</span>
<span class="s2">data = self.preprocess(data)</span>

<span class="s2"># Featurize the data</span>
<span class="s2">encoded_ds = self.featurize(</span><span class="se">{{</span><span class="s2">&quot;predict_data&quot;: data</span><span class="se">}}</span><span class="s2">)[&quot;predict_data&quot;]</span>
<span class="s2">encoded_data = encoded_ds.get_encoded_data(include_target=False)</span>

<span class="s2">self.pred_args = PredictionArguments.from_dict(args)</span>
<span class="s2">df = self.ensemble(encoded_ds, args=self.pred_args)</span>

<span class="s2">if self.pred_args.all_mixers:</span>
<span class="s2">    return df</span>
<span class="s2">else:</span>
<span class="s2">    insights, global_insights = </span><span class="si">{</span><span class="n">call</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">explainer</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    return insights</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">predict_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">predict_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">predictor_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">IMPORTS</span><span class="si">}</span><span class="s2"></span>
<span class="si">{</span><span class="n">IMPORT_EXTERNAL_DIRS</span><span class="si">}</span><span class="s2"></span>

<span class="s2">class Predictor(PredictorInterface):</span>
<span class="s2">    target: str</span>
<span class="s2">    mixers: List[BaseMixer]</span>
<span class="s2">    encoders: Dict[str, BaseEncoder]</span>
<span class="s2">    ensemble: BaseEnsemble</span>
<span class="s2">    mode: str</span>

<span class="s2">    def __init__(self):</span>
<span class="s2">        seed(</span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">seed_nr</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        self.target = &#39;</span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        self.mode = &#39;inactive&#39;</span>
<span class="s2">        self.problem_definition = ProblemDefinition.from_dict(</span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        self.accuracy_functions = </span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">accuracy_functions</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        self.identifiers = </span><span class="si">{</span><span class="n">json_ai</span><span class="o">.</span><span class="n">identifiers</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        self.dtype_dict = </span><span class="si">{</span><span class="n">inline_dict</span><span class="p">(</span><span class="n">dtype_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        # Any feature-column dependencies</span>
<span class="s2">        self.dependencies = </span><span class="si">{</span><span class="n">inline_dict</span><span class="p">(</span><span class="n">dependency_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        self.input_cols = [</span><span class="si">{</span><span class="n">input_cols</span><span class="si">}</span><span class="s2">]</span>

<span class="s2">        # Initial stats analysis</span>
<span class="s2">        self.statistical_analysis = None</span>


<span class="s2">    def analyze_data(self, data: pd.DataFrame) -&gt; None:</span>
<span class="s2">        # Perform a statistical analysis on the unprocessed data</span>
<span class="si">{</span><span class="n">analyze_data_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def preprocess(self, data: pd.DataFrame) -&gt; pd.DataFrame:</span>
<span class="s2">        # Preprocess and clean data</span>
<span class="si">{</span><span class="n">clean_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def split(self, data: pd.DataFrame) -&gt; Dict[str, pd.DataFrame]:</span>
<span class="s2">        # Split the data into training/testing splits</span>
<span class="si">{</span><span class="n">split_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def prepare(self, data: Dict[str, pd.DataFrame]) -&gt; None:</span>
<span class="s2">        # Prepare encoders to featurize data</span>
<span class="si">{</span><span class="n">prepare_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def featurize(self, split_data: Dict[str, pd.DataFrame]):</span>
<span class="s2">        # Featurize data into numerical representations for models</span>
<span class="si">{</span><span class="n">feature_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def fit(self, enc_data: Dict[str, pd.DataFrame]) -&gt; None:</span>
<span class="s2">        # Fit predictors to estimate target</span>
<span class="si">{</span><span class="n">fit_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def analyze_ensemble(self, enc_data: Dict[str, pd.DataFrame]) -&gt; None:</span>
<span class="s2">        # Evaluate quality of fit for the ensemble of mixers</span>
<span class="si">{</span><span class="n">analyze_ensemble</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def learn(self, data: pd.DataFrame) -&gt; None:</span>
<span class="s2">        log.info(f&#39;Dropping features: </span><span class="se">{{</span><span class="s2">self.problem_definition.ignore_features</span><span class="se">}}</span><span class="s2">&#39;)</span>
<span class="s2">        data = data.drop(columns=self.problem_definition.ignore_features, errors=&#39;ignore&#39;)</span>
<span class="si">{</span><span class="n">learn_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def adjust(self, new_data: Dict[str, pd.DataFrame]) -&gt; None:</span>
<span class="s2">        # Update mixers with new information</span>
<span class="si">{</span><span class="n">adjust_body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    def predict(self, data: pd.DataFrame, args: Dict = </span><span class="se">{{}}</span><span class="s2">) -&gt; pd.DataFrame:</span>
<span class="si">{</span><span class="n">predict_body</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">black</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">black</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">black</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unable to import black formatter, predictor code might be a bit ugly.&#39;</span><span class="p">)</span>
        <span class="n">predictor_code</span> <span class="o">=</span> <span class="n">black</span><span class="o">.</span><span class="n">format_str</span><span class="p">(</span><span class="n">predictor_code</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">black</span><span class="o">.</span><span class="n">FileMode</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">predictor_code</span></div>


<div class="viewcode-block" id="validate_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.validate_json_ai">[docs]</a><span class="k">def</span> <span class="nf">validate_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the validity of a ``JsonAI`` object</span>

<span class="sd">    :param json_ai: A ``JsonAI`` object</span>

<span class="sd">    :returns: Whether the JsonAI is valid, i.e. doesn&#39;t contain prohibited values, unknown values and can be turned into code.</span>
<span class="sd">    &quot;&quot;&quot;</span> <span class="c1"># noqa</span>
    <span class="kn">from</span> <span class="nn">lightwood.api.high_level</span> <span class="kn">import</span> <span class="n">predictor_from_code</span><span class="p">,</span> <span class="n">code_from_json_ai</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">predictor_from_code</span><span class="p">(</span><span class="n">code_from_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2021, MindsDB.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>